<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin Panel</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
<header>
  <h1>Admin Panel</h1>
  <div>
    <a href="/">Ke Toko</a>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<main>
  <section>
    <h2>Tambah Produk</h2>
    <form id="addForm">
      <input id="add-name" placeholder="Nama produk" required>
      <input id="add-price" type="number" placeholder="Harga" required>
      <input id="add-stock" type="number" placeholder="Stok" required>
      <input id="add-wa" placeholder="No. WhatsApp">
      <textarea id="add-desc" placeholder="Deskripsi"></textarea>
      <button type="submit">Tambah Produk</button>
    </form>
  </section>

  <section>
    <h2>Tambah Admin</h2>
    <form id="addUserForm">
      <input id="new-user" placeholder="Username baru" required>
      <input id="new-pass" placeholder="Password baru" required>
      <button type="submit">Tambah Admin</button>
      <p id="addUserMsg"></p>
    </form>
  </section>

  <section>
    <h2>Daftar Produk</h2>
    <div id="list-wrap"></div>
  </section>
</main>

<script>
const tokenKey='admin_token';
function getToken(){ return localStorage.getItem(tokenKey); }
function clearToken(){ localStorage.removeItem(tokenKey); localStorage.removeItem('admin_user'); }

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  clearToken();
  window.location.href='/admin-login';
});

// cek login
if(!getToken()) window.location.href='/admin-login';

async function loadList(){
  const res=await fetch('/api/stok');
  const arr=await res.json();
  const wrap=document.getElementById('list-wrap');
  wrap.innerHTML='';
  if(!arr.length){ wrap.innerHTML='<p>Belum ada produk.</p>'; return; }
  arr.forEach(p=>{
    const el=document.createElement('div');
    el.innerHTML=`
      <h3>${p.nama}</h3>
      <p>Rp${p.harga} â€¢ Stok: ${p.stock}</p>
      <p>${p.deskripsi||''}</p>
      <p>WA: <a href="https://wa.me/${p.wa||''}" target="_blank">Chat</a></p>
      <button data-id="${p.id}" data-action="del">Hapus</button>
    `;
    wrap.appendChild(el);
  });

  wrap.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id=btn.dataset.id;
      await fetch('/api/stok',{
        method:'DELETE',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()},
        body:JSON.stringify({id})
      });
      loadList();
    });
  });
}

// tambah produk
document.getElementById('addForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const body={
    nama: document.getElementById('add-name').value,
    harga: Number(document.getElementById('add-price').value),
    stock: Number(document.getElementById('add-stock').value),
    wa: document.getElementById('add-wa').value,
    deskripsi: document.getElementById('add-desc').value
  };
  await fetch('/api/stok',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()},
    body:JSON.stringify(body)
  });
  e.target.reset();
  loadList();
});

// tambah admin
document.getElementById('addUserForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const body={
    user: document.getElementById('new-user').value,
    pass: document.getElementById('new-pass').value
  };
  const res=await fetch('/api/users',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()},
    body:JSON.stringify(body)
  });
  const j=await res.json();
  document.getElementById('addUserMsg').innerText=j.message||'OK';
  e.target.reset();
});

loadList();
</script>
</body>
</html>
